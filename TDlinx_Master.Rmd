---
title: "Create a List of Opportunity Accounts by Joining TDLinx Master Data & VIPSAM2"
author: "Ben Graft"
date: "11/9/2020"
output: html_document
---

### Load Libraries
```{r}
library(tidyverse)
library(purrr)
library(odbc)
library(RODBC)
library(dplyr)
library(ggplot2)
library(gtable)
library(stringi)
library(DBI)
library(naniar)
library(stringr)
library(lubridate)
library(maps)
library(readr)
library(tidyr)

con <- dbConnect(odbc::odbc(), dsn = "CLPImpala")

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, tidy = TRUE)

```

### Pull All Open Stores from TDLinx Master Data Source
```{sql connection=con, output.var="TDlinx_master"}

SELECT DISTINCT stdlinxscd as 'tdlinx_number', store_status, store_name, store_street_address, store_city, store_state, store_zip, store_latitude, store_longitude, premise_type, sells_distilled_spirits, sells_wine, sells_beer FROM dp_data_science.vwb_stb_tdlinx
WHERE store_status = "Open Store"


```

Trim the field `store_zip` to just the first 5 digits
```{r}

TDlinx_master <- TDlinx_master %>% 
  mutate(store_zip = trimws(
    stringr::str_sub(
      string = store_zip, start = 1, end = 5)
    ))

```

<!-- ### check if TDLinx Master has any duplicates -->
```{r eval=FALSE, echo = FALSE}
df_tdlinx_master_check <- TDlinx_master %>% 
  group_by(tdlinx_number) %>% 
  mutate(row_id = row_number(),
         max_row_id = max(row_id)) %>% 
  filter(max_row_id > 1)

```

### Pull All SKUs level information for all brands and associated 12-month Rolling Volume
```{sql connection=con, output.var="vipsam2"}

SELECT tdlinx_number, brand_name, SUM(v12_month_cases_9l) as 'v12_month_cases_9l', sells_distilled_spirits, sells_wine, sells_beer
FROM aa_data_science_staging.aa_eh_tbl_vipsamii 
WHERE t_date = (SELECT MAX(t_date) FROM aa_data_science_staging.aa_eh_tbl_vipsamii) and 
store_status = "Open Store"
GROUP BY tdlinx_number, brand_name, sells_distilled_spirits, sells_wine, sells_beer

```

### Once POC is agreed upon, then the vipsam2 data will be pulled at the Brand, Sub_Brand, Bottle_Size, and SKU level
This will be the query for identifying PODs opportunties.
```{sql connection=con, output.var="vipsam2", eval=FALSE, echo = FALSE}

SELECT tdlinx_number, brand_name, sub_brand_name, bottle_size, sku, MAX(t_date) as 'date', SUM(v12_month_cases_9l) as 'v12_month_cases_9l', sells_distilled_spirits, sells_wine, sells_beer
FROM aa_data_science_staging.aa_eh_tbl_vipsamii 
WHERE t_date = (SELECT MAX(t_date) FROM aa_data_science_staging.aa_eh_tbl_vipsamii) 
GROUP BY tdlinx_number, brand_name, t_date, sub_brand_name, bottle_size, sku, sells_distilled_spirits, sells_wine, sells_beer

```

### Create Dataframe that has a tdlinx_number associated with every brand
<!-- , sub_brand, bottle_size, sku combination. -->
* (For the POC only use Brand. The final product will include brand, sub_brand, bottle_size, and sku)
```{r}

vipsam2 <- vipsam2 %>%
  mutate(
    product_type = case_when(
      #Spirits
      brand_name == "OF 100P" ~ "Spirit",
      brand_name == "JD Tennessee Fire" ~ "Spirit",
      brand_name == "JD Tennessee Honey" ~ "Spirit",
      brand_name == "JD Tennessee Apple" ~ "Spirit",
      brand_name == "JD Tennessee Rye" ~ "Spirit",
      brand_name == "Jack Daniels Tenness" ~ "Spirit",
      brand_name == "OF 86P" ~ "Spirit",
      brand_name == "Coopers Bourbon" ~ "Spirit",
      brand_name == "OF Rye" ~ "Spirit",
      brand_name == "WR Double Oaked" ~ "Spirit",
      brand_name == "JD Single Barrel" ~ "Spirit",
      brand_name == "JDSB Barrel Proof" ~ "Spirit",
      brand_name == "OF Craft & SBBL" ~ "Spirit",
      brand_name == "Woodford Reserve" ~ "Spirit",
      brand_name == "Gentleman Jack" ~ "Spirit",
      brand_name == "Slane Irish Whiskey" ~ "Spirit",
      brand_name == "WR Rye" ~ "Spirit",
      brand_name == "Chambord" ~ "Spirit",
      brand_name == "Herradura" ~ "Spirit",
      brand_name == "BenRiach" ~ "Spirit",
      brand_name == "Fords Gin" ~ "Spirit",
      brand_name == "Korbel Brandy" ~ "Spirit",
      brand_name == "JD Winter Jack" ~ "Spirit",
      brand_name == "WR Straight Malt" ~ "Spirit",
      brand_name == "Pepe Lopez" ~ "Spirit",
      brand_name == "El Jimador" ~ "Spirit",
      brand_name == "JD Gold" ~ "Spirit",
      brand_name == "JD Sinatra" ~ "Spirit",
      brand_name == "OF Mint Julep" ~ "Spirit",
      brand_name == "Finlandia Vodka" ~ "Spirit",
      brand_name == "JD Craft Rye" ~ "Spirit",
      brand_name == "King of Kentucky" ~ "Spirit",
      brand_name == "Don Eduardo" ~ "Spirit",
      brand_name == "Herradura Ultra" ~ "Spirit",
      brand_name == "GlenDronach" ~ "Spirit",
      brand_name == "WR Luxury" ~ "Spirit",
      brand_name == "HR Seleccion Suprema" ~ "Spirit",
      brand_name == "WR Straight Wheat" ~ "Spirit",
      brand_name == "GlenGlassaugh" ~ "Spirit",
      brand_name == "Tequila Non-Alcohol" ~ "Spirit",
      brand_name == "EJ Flavors" ~ "Spirit",
      brand_name == "LBD Vodka" ~ "Spirit",
      brand_name == "HR Legend" ~ "Spirit",
      brand_name == "HR Coleccion De La C" ~ "Spirit",
      brand_name == "Chambord Flavored Vo" ~ "Spirit",
      brand_name == "Antiguo" ~ "Spirit",
      brand_name == "Herradura Specialtie" ~ "Spirit",
      # RTDs
      brand_name == "JD & Cola" ~ "RTD",
      brand_name == "JD RTDs Other" ~ "RTD",
      brand_name == "JD TN Honey RTD" ~ "RTD",
      brand_name == "JD Country Cocktails" ~ "RTD",
      brand_name == "New Mix" ~ "RTD",
      # Wines
      brand_name == "Sonoma-Cutrer" ~ "Wine",
      brand_name == "Korbel Champagne" ~ "Wine",
      brand_name == "Korbel Prosecco" ~ "Wine"
    )
  )

# This becomes SKU level for PODs Opportunties.
# df_brands <- vipsam2 %>%
#   select(sku, product_type) %>%
#   unique()

df_brands <- vipsam2 %>%
  select(brand_name, product_type) %>%
  unique()

# split data frames by `product_type`
df_brands_spirits <- df_brands %>% filter(product_type == "Spirit")
df_brands_rtd <- df_brands %>% filter(product_type == "RTD")
df_brands_wine <- df_brands %>% filter(product_type == "Wine")
```

### Split TDlinx data by "sells_`product_type`" fields
```{r}
# create dataframe of tdlinx
df_tdlinx <- TDlinx_master %>% 
  select(tdlinx_number, sells_distilled_spirits, sells_wine, sells_beer) %>% 
  unique()

df_tdlinx_wide_spirits <- df_tdlinx %>% 
  mutate(tdlinx_number = paste0("v_", tdlinx_number), 
         Value = 1) %>%
  filter(sells_distilled_spirits == "Yes") %>% 
  spread(key = tdlinx_number, value = Value, fill = 0) %>% 
  select(-c(sells_distilled_spirits, sells_beer, sells_wine))

df_tdlinx_wide_rtd <- df_tdlinx %>% 
  mutate(tdlinx_number = paste0("v_", tdlinx_number), 
         Value = 1) %>%
  filter(sells_beer == "Yes") %>% 
  spread(key = tdlinx_number, value = Value, fill = 0) %>% 
  select(-c(sells_distilled_spirits, sells_beer, sells_wine))

df_tdlinx_wide_wine <- df_tdlinx %>% 
  mutate(tdlinx_number = paste0("v_", tdlinx_number), 
         Value = 1) %>%
  filter(sells_wine == "Yes") %>% 
  spread(key = tdlinx_number, value = Value, fill = 0) %>% 
  select(-c(sells_distilled_spirits, sells_beer, sells_wine))
```


### Bind the brands and tdlinx dfs, create a list of df (1 for each product type)
```{r}
# bind the brands and tdlinx dfs
df_bind_spirits <- bind_rows(df_brands_spirits, df_tdlinx_wide_spirits) 
df_bind_rtd <- bind_rows(df_brands_rtd, df_tdlinx_wide_rtd) 
df_bind_wine <- bind_rows(df_brands_wine, df_tdlinx_wide_wine) 

df_list <- list(df_bind_spirits, df_bind_rtd, df_bind_wine)

rm(df_brands_spirits, df_tdlinx_wide_spirits, df_brands_rtd, df_tdlinx_wide_rtd, df_brands_wine, df_tdlinx_wide_wine)
```


### Create Dataframe that has a tdlinx_number associated with every brand
```{r}
# gather all tdlinx numbers into 1 column, so now there is a tdlinx_number associated with every brand
# after POC is agreed upon every tdlinx_number will be associated with every (brand, sub_brand, bottle_size, and sku combination.)
df_gather_list <- lapply(df_list, function(x)  {
  pivot_longer(data = x, 
               cols = starts_with("v_"),
               names_to = "tdlinx_number",
               values_to = "Value") %>%
    mutate(tdlinx_number = gsub("v_", "", tdlinx_number)) %>%
    select(-Value)
})

rm(df_bind_spirits, df_bind_rtd, df_bind_wine)

```

```{r}

vipsam2_spirits <- vipsam2 %>% 
  filter(product_type == "Spirit", sells_distilled_spirits == "Yes")
vipsam2_rtd <- vipsam2 %>% 
  filter(product_type == "RTD", sells_beer == "Yes")
vipsam2_wine <- vipsam2 %>% 
  filter(product_type == "Wine", sells_wine == "Yes")

# Join df_gather& vipsam2, and replace NAs with zero for 12-month rolling volume
df_spirits <- full_join(x = df_gather_list[[1]], y = vipsam2_spirits) %>% 
  mutate(v12_month_cases_9l = replace_na(v12_month_cases_9l, replace = 0))

df_rtd <- full_join(x = df_gather_list[[2]], y = vipsam2_rtd) %>% 
  mutate(v12_month_cases_9l = replace_na(v12_month_cases_9l, replace = 0))

df_wine <- full_join(x = df_gather_list[[3]], y = vipsam2_wine) %>% 
  mutate(v12_month_cases_9l = replace_na(v12_month_cases_9l, replace = 0))


```

### Filter TDLinx by "sells_`product_type`" & Join with df_`product_type`
```{r}

TDlinx_master_spirits <- TDlinx_master %>% filter(sells_distilled_spirits == "Yes")
TDlinx_master_rtd <- TDlinx_master %>% filter(sells_beer == "Yes")
TDlinx_master_wine <- TDlinx_master %>% filter(sells_wine == "Yes")

df_spirits <- full_join(df_spirits, TDlinx_master_spirits)
df_rtd <- full_join(df_rtd, TDlinx_master_rtd)
df_wine <- full_join(df_wine, TDlinx_master_wine)

rm(TDlinx_master_spirits, TDlinx_master_rtd, TDlinx_master_wine, vipsam2_spirits, vipsam2_rtd, vipsam2_wine)
```

### Create field for full address 
For display purposes in Tableau & geocoding, if necessary
```{r}
df_spirits <- df_spirits %>% mutate(
  store_address = paste0(store_street_address, ", ", store_city, ", ", store_state, " ", store_zip), 
  universe = "Spirits")

df_rtd <- df_rtd %>% mutate(
  store_address = paste0(store_street_address, ", ", store_city, ", ", store_state, " ", store_zip), 
  universe = "RTD")

df_wine <- df_wine %>% mutate(
  store_address = paste0(store_street_address, ", ", store_city, ", ", store_state, " ", store_zip), 
  universe = "Wine")
```


### Bind Data Frames and Write to CSV
bind the 3 data frames, now that we have created a field `universe` it will be possible to utilize one file and still consider the correct number of stores. 
```{r}

df <- bind_rows(df_spirits, df_rtd, df_wine)

write_csv(x = df, path = "/data1/home/bi6ekbg/vipsam2/RTC_account_opportunities.csv")

```
